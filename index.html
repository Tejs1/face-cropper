<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Face-focused Photo Cropper (BlazeFace) with Bounding Boxes</title>
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
		<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@latest"></script>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
			}
			#fileInput {
				display: none;
			}
			#uploadButton {
				padding: 10px 20px;
				background-color: #4caf50;
				color: white;
				border: none;
				cursor: pointer;
			}
			#originalImageContainer,
			#croppedImage {
				max-width: 100%;
				margin-top: 20px;
			}
			#originalImageCanvas {
				max-width: 100%;
				height: auto;
			}
			#status {
				color: #666;
				margin-top: 10px;
			}
		</style>
	</head>
	<body>
		<h1>Face-focused Photo Cropper with Bounding Boxes</h1>
		<input type="file" id="fileInput" accept="image/*" />
		<button id="uploadButton" disabled>Upload Photo</button>
		<div id="status">Loading face detection model...</div>
		<div id="originalImageContainer">
			<h2>Original Image with Bounding Boxes:</h2>
			<canvas id="originalImageCanvas"></canvas>
		</div>
		<div>
			<h2>Cropped Image:</h2>
			<img id="croppedImage" alt="Cropped image" />
		</div>

		<script>
			let model

			async function loadModel() {
				try {
					model = await blazeface.load()
					document.getElementById("status").textContent =
						"Face detection model loaded. Ready to process images."
					document.getElementById("uploadButton").disabled = false
				} catch (error) {
					console.error("Error loading BlazeFace model:", error)
					document.getElementById(
						"status",
					).textContent = `Error loading model: ${error.message}. Please reload the page.`
				}
			}

			async function detectFace(img) {
				const predictions = await model.estimateFaces(img, false)
				if (predictions.length > 0) {
					return predictions[0]
				}
				return null
			}

			function drawBoundingBoxes(img, face, cropBox) {
				const canvas = document.getElementById("originalImageCanvas")
				const ctx = canvas.getContext("2d")

				// Set canvas size to match the image
				canvas.width = img.width
				canvas.height = img.height

				// Draw the original image
				ctx.drawImage(img, 0, 0, img.width, img.height)

				// Draw face bounding box
				ctx.strokeStyle = "blue"
				ctx.lineWidth = 3
				ctx.strokeRect(
					face.topLeft[0],
					face.topLeft[1],
					face.bottomRight[0] - face.topLeft[0],
					face.bottomRight[1] - face.topLeft[1],
				)

				// Draw crop bounding box
				ctx.strokeStyle = "green"
				ctx.lineWidth = 3
				ctx.strokeRect(cropBox.x, cropBox.y, cropBox.size, cropBox.size)
			}

			function cropImage(img, face, targetFacePercent = 0.6) {
				const canvas = document.createElement("canvas")
				const ctx = canvas.getContext("2d")

				const faceWidth = face.bottomRight[0] - face.topLeft[0]
				const faceHeight = face.bottomRight[1] - face.topLeft[1]
				const faceCenterX = (face.topLeft[0] + face.bottomRight[0]) / 2
				const faceCenterY = (face.topLeft[1] + face.bottomRight[1]) / 2

				const cropSize = Math.max(faceWidth, faceHeight) / targetFacePercent

				canvas.width = cropSize
				canvas.height = cropSize

				const sourceX = faceCenterX - cropSize / 2
				const sourceY = faceCenterY - cropSize / 2

				ctx.drawImage(
					img,
					sourceX,
					sourceY,
					cropSize,
					cropSize,
					0,
					0,
					cropSize,
					cropSize,
				)

				return {
					dataUrl: canvas.toDataURL(),
					cropBox: { x: sourceX, y: sourceY, size: cropSize },
				}
			}

			document.addEventListener("DOMContentLoaded", () => {
				const fileInput = document.getElementById("fileInput")
				const uploadButton = document.getElementById("uploadButton")
				const croppedImage = document.getElementById("croppedImage")
				const statusElement = document.getElementById("status")

				uploadButton.addEventListener("click", () => fileInput.click())

				loadModel()

				fileInput.addEventListener("change", async e => {
					const file = e.target.files[0]
					if (!file) return

					try {
						const img = new Image()
						img.onload = async () => {
							const face = await detectFace(img)
							console.log(face)
							if (face) {
								const { dataUrl, cropBox } = cropImage(img, face)
								croppedImage.src = dataUrl
								drawBoundingBoxes(img, face, cropBox)
								statusElement.textContent = "Image processed successfully."
							} else {
								statusElement.textContent = "No face detected in the image."
							}
						}
						img.src = URL.createObjectURL(file)
					} catch (error) {
						console.error("Error processing image:", error)
						statusElement.textContent = `Error processing image: ${error.message}. Please try again.`
					}
				})
			})
		</script>
	</body>
</html>
